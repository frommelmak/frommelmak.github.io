<!DOCTYPE html>
<html lang="es">
<head>
          <title>frommelmak - Backup completo de un guest Linux mediante&nbsp;tar</title>
        <meta charset="utf-8" />




    <meta name="tags" content="backup" />
    <meta name="tags" content="tar" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://frommelmak.com/">frommelmak <strong>Yet another Melmacian interested in technology...</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Home</a></li>
            <li><a href="https://frommelmak.com/pages/about.html">About</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://frommelmak.com/backup-completo-de-un-guest-linux-mediante-tar.html" rel="bookmark"
         title="Permalink to Backup completo de un guest Linux mediante tar">Backup completo de un guest Linux mediante&nbsp;tar</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2010-05-03T17:25:39+02:00">
      Mon 03 May 2010
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://frommelmak.com/author/frommelmak.html">frommelmak</a>
    </address>
    <div class="category">
        Category: <a href="https://frommelmak.com/category/spanish.html">Spanish</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://frommelmak.com/tag/backup.html">backup</a>
            <a href="https://frommelmak.com/tag/tar.html">tar</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Clonar una mquina virtual mediante <em>VMWare Converter</em> suele ser un proceso lento, especialmente si la máquina tiene un disco grande, este el espacio ocupado o no. En ocasiones, ya no es que sea lento, sino que directamente el <em>VMWare Converter</em> falla inexplicablemente. En estos caso tenemos dos opciones. O bien copiar el disco de la máquina mediante <span class="caps">SSH</span> (si tenemos acceso <code>ssh</code> al <em>ESXi</em>) o bien hacer un <em>tarball</em> de todo el sistema y extraerlo en una nueva&nbsp;máquina.</p>
<p>A continuacóin detallo los pasos para realizar este último&nbsp;procedimiento.</p>
<p>En primer lugar hay que crear el <code>tar.gz</code> de la máquina origen. Para ello, conectamos por <span class="caps">SSH</span> y nos aseguramos de que disponemos de espacio. Luego ejecutamos el comando que vuelca toda la raiz del sistema a un <em>tarball</em>:</p>
<div class="highlight"><pre><span></span><span class="go">cd /</span>
<span class="go">tar cvlz --exclude=./tmp/* --exclude=./var/tmp/* --exclude=./proc/* --exclude=./sys/* --exclude=./mnt/* -f /var/tmp/guest_backup.tar.gz .</span>
</pre></div>


<p>En primer lugar necesitamos una <span class="caps">ISO</span> bootable de un sistema Linux con las herramientas necesarias para hacer la extracción y restauración del <em>tarball</em>. Una buena distro para estos menesteres es <span class="caps">RIP</span>&nbsp;Linux.</p>
<p><a href="http://rip.7bf.de/current/RIPLinux-9.3-non-X.iso"><span class="caps">RIP</span> Linux&nbsp;Image</a></p>
<p>Copiaremos esta <span class="caps">ISO</span> al datastore del ESXi de&nbsp;destino.</p>
<p>Ahora creamos una máquina en el ESXi de destino con un disco de igual tamao al que queremos copiar y configuraremos esta máquina para que arranque con la <span class="caps">ISO</span> de <span class="caps">RIP</span>&nbsp;Linux.</p>
<p>Particionamos el disco <code>sda</code> de la máquina y lo&nbsp;formateamos.</p>
<div class="highlight"><pre><span></span><span class="go">fdisk /dev/sda</span>
<span class="go">mkfs.ext3 /dev/sda1</span>
<span class="go">mkswap /dev/sda2</span>
<span class="go">mount /dev/sda1 /mnt/sda1</span>
</pre></div>


<p>Nos asignamos una <span class="caps">IP</span> y copiamos el <code>tar.gz</code> a la via <code>scp</code> y extraemos el <em>tarball</em>.</p>
<div class="highlight"><pre><span></span><span class="go">ifconfig eth0 x.x.x.x</span>
<span class="go">cd /mnt/sda1</span>
<span class="go">scp user@host:/guest_backup.tar.gz .</span>
<span class="go">tar zxvf guest_backup.tar.gz</span>
<span class="go">chroot /mnt/sda1</span>
<span class="go">grub-mkconfig /boot/grub/grub.cfg</span>
<span class="go">grub-install /dev/sda</span>
</pre></div>


<p>Ahora ya podemos reiniciar el&nbsp;equipo.</p>
<p>Si teniamos <em>mysql</em> corriendo, deberemos restablecer el owner de los siguientes directorios, ya que el <span class="caps">UID</span> de mysql en diferente en Debian al de <span class="caps">RIP</span>&nbsp;Linux.</p>
<div class="highlight"><pre><span></span><span class="go">chown -R mysql /var/run/mysqld</span>
<span class="go">chown -R mysql /var/log/mysql</span>
<span class="go">chown -R mysql /var/log/mysql.*</span>
<span class="go">chown -R mysql.mysql /var/lib/mysql</span>
</pre></div>


<p>Es posible que tengamos que repetir el mismo procedimiento si utilizabamos servicios que corran bajo un usuario cuyo <span class="caps">UID</span> difiera del que utiliza <span class="caps">RIP</span>&nbsp;Linux.</p>
<p>Finalmente, si nuestro <code>fstab</code> hacia referencia a UUIDs en lugar de a devices, lo mejor es modificarlo y asegurarnos que utiliza los devices que&nbsp;toca.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>