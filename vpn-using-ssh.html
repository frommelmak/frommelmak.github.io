<!DOCTYPE html>
<html lang="es">
<head>
          <title>frommelmak - <span class="caps">VPN</span> using <span class="caps">SSH</span></title>
        <meta charset="utf-8" />




    <meta name="tags" content="ssh" />
    <meta name="tags" content="vpn" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://frommelmak.com/">frommelmak <strong>Yet another Melmacian interested in technology...</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Home</a></li>
            <li><a href="https://frommelmak.com/pages/about.html">About</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://frommelmak.com/vpn-using-ssh.html" rel="bookmark"
         title="Permalink to VPN using SSH"><span class="caps">VPN</span> using <span class="caps">SSH</span></a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2011-09-12T19:29:21+02:00">
      Mon 12 September 2011
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://frommelmak.com/author/frommelmak.html">frommelmak</a>
    </address>
    <div class="category">
        Category: <a href="https://frommelmak.com/category/english.html">English</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://frommelmak.com/tag/ssh.html">ssh</a>
            <a href="https://frommelmak.com/tag/vpn.html">vpn</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Las versiones recientes del servidor OpenSSH permiten montar una <span class="caps">VPN</span> utilizando una conexinSSH. Esto nos permite, por ejemplo, tener acceso a todos los puertos del servidor incluso en aquellos casos en los que s√≥lo nos dan acceso al puerto de <span class="caps">SSH</span>.</p>
<p>Para montar una <span class="caps">VPN</span> utilizando el servidorSSHen Debian haremos lo&nbsp;siguiente&#8230;        </p>
<h2><span class="caps">SERVER</span>:</h2>
<p>Aadimos en <code>/etc/ssh/sshd_config</code></p>
<div class="highlight"><pre><span></span><span class="go">PermitTunnel point-to-point</span>
<span class="go">PermitRootLogin yes</span>
</pre></div>


<p>Para crear el dispositivo <span class="caps">TUN</span> es necesario ejecutar algunos comandos como root, por eso utilizamos la directiva <code>PermiRootLogin</code> a yes. Si no queremos dar acceso de login al usuario root, podemos utilizar otras soluciones ms elegantes como: <code>forzed-commands-only</code> o  <code>without-password</code> que no comprometen tanto la seguridad como <code>PermitRootLogin yes</code>. Ver enlaces relaccionados al final del&nbsp;documento.</p>
<p>Finalmente, recuerda que es necesario reiniciar el servidorSSHpara que los cambios tengan&nbsp;efecto.</p>
<p>Editamos: <code>/etc/network/interfaces</code></p>
<div class="highlight"><pre><span></span><span class="go">allow-hotplug tun0</span>
<span class="go">iface tun0 inet static</span>
<span class="go">      address 10.0.0.1</span>
<span class="go">      netmask 255.255.255.0</span>
<span class="go">      pointopoint 10.0.0.2</span>
</pre></div>


<p>Es vital utilizar <code>allow-hotplug tun0</code>para que se creen automticamente los dispositivos tun con udev, de lo contrario deberemos utilizar herramientas como <code>tunctl</code>para crear los dispositivos, lo cual puede darnos problemas de permisos al intentar abrir/crear los&nbsp;dispositivos.</p>
<h2><span class="caps">CLIENT</span>:</h2>
<p>Editamos: <code>/etc/network/interfaces</code></p>
<div class="highlight"><pre><span></span><span class="go">allow-hotplug tun0</span>
<span class="go">iface tun0 inet static</span>
<span class="go">      pre-up ssh -vv -i /root/.ssh/id_rsa -S /var/run/ssh-vpn-tunnel-control -M -f -w 0:0 root@ssh_server true</span>
<span class="go">      pre-up sleep 5</span>
<span class="go">      address 10.0.0.2</span>
<span class="go">      pointopoint 10.0.0.1</span>
<span class="go">      netmask 255.255.255.0</span>
<span class="gp">      #</span>up route add -net <span class="m">192</span>.168.1.0 netmask <span class="m">255</span>.255.255.0 tun0 <span class="c1">#creating optional route</span>
<span class="gp">      #</span>down route del -net <span class="m">192</span>.168.1.0 netmask <span class="m">255</span>.255.255.0 tun0 <span class="c1">#creating optional route</span>
<span class="go">      post-down ssh -i/root/.ssh/id_rsa -S /var/run/ssh-vpn-tunnel-control -O exit root@ssh_server</span>
</pre></div>


<p>Con esto conseguimos establecer una conexin punto a punto con el servidor ssh remoto, si bien, en ocasiones querremos ir un poco ms all. Por ejemplog. Si queremos llegar a otoros equipos ubicados en la red remota, o al reves, cuando varios equipos de nuestra red han de poder llegar al servidor&nbsp;remoto.</p>
<p>Se asume que hemos creado el par de claves privada/publica <code>id_rsa/id_rsa.pub</code>y que hemos copiado la publica al servidor <span class="caps">SSH</span> remoto para poder autenticar sin necesidad de proporcionar&nbsp;password.</p>
<h3>Arrancar y detener la <span class="caps">VPN</span></h3>
<p>Para iniciar la conexin punto a punto utilizaremos los comandos <code>ifup tun0</code> e <code>ifdown tun0</code> respectivamente.</p>
<p>Ahora ya ponemos alcanzar el servidor remoto en&nbsp;10.0.0.1.</p>
<p>Tras establecer la conexin punto a punto, y en base a nuestras necesidades, podemos encontrarnos diferentes escenarios. Por&nbsp;ejemplo:</p>
<h3>Acceso a otros equipos de la red&nbsp;remota</h3>
<p>Activamos el forwarding en el servidorSSH y&nbsp;ejecutamos:</p>
<div class="highlight"><pre><span></span><span class="go">iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o eth0 -j MASQUERADE</span>
</pre></div>


<h3>Acceso al servidor remoto desde varios equipos de nuestra&nbsp;red</h3>
<p>Activamos el forwarding en el cliente de ssh y&nbsp;ejecutamos:</p>
<div class="highlight"><pre><span></span><span class="go">iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE</span>
</pre></div>


<p>En cada uno de los equipos de red que deseamos que tengan acceso al servidor, deberemos configurar la ruta&nbsp;correspondiente:</p>
<p>Por ejemplo en&nbsp;windows:</p>
<div class="highlight"><pre><span></span><span class="go">route add 10.0.0.0 mask 255.255.255.0 IP_SSH_CLIENT</span>
</pre></div>


<p><strong>Nota</strong>: Para activar el forwarding en ambos casos: <code>sysctl -w net.ipv4.ip_forward=1</code></p>
<p>Fuentes: </p>
<ul>
<li><a href="">bodhizazen.net/Tutorials/<span class="caps">VPN</span>-Over-<span class="caps">SSH</span></a></li>
<li><a href="">www.debian-administration.org/articles/539</a></li>
</ul>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>