<!DOCTYPE html>
<html lang="es">
<head>
          <title>frommelmak - Establecer una conexion OpenVPN desde una tarea de&nbsp;cron</title>
        <meta charset="utf-8" />




    <meta name="tags" content="cron" />
    <meta name="tags" content="openvpn" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://frommelmak.com/">frommelmak <strong>Yet another Melmacian interested in technology...</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Home</a></li>
            <li><a href="https://frommelmak.com/pages/about.html">About</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://frommelmak.com/establecer-una-conexion-openvpn-desde-una-tarea-de-cron.html" rel="bookmark"
         title="Permalink to Establecer una conexion OpenVPN desde una tarea de cron">Establecer una conexion OpenVPN desde una tarea de&nbsp;cron</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2008-12-31T00:21:36+01:00">
      Wed 31 December 2008
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://frommelmak.com/author/frommelmak.html">frommelmak</a>
    </address>
    <div class="category">
        Category: <a href="https://frommelmak.com/category/spanish.html">Spanish</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://frommelmak.com/tag/cron.html">cron</a>
            <a href="https://frommelmak.com/tag/openvpn.html">openvpn</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Es muy típico que un script que funciona perfectamente desde una sesión de usuario normal falle al correr como un trabajo ejecutado por el&nbsp;cron.</p>
<p>Generalmente esto es debido a que las variables de entorno bajo las que se ejecuta el script en uno y otro caso no son las&nbsp;mismas.</p>
<p>En el caso de lanzar OpenVPN como demonio desde una tarea de cron es importante tener esto en cuenta, ya que OpenVPN tras la autenticación llamará al comando <code>ifconfig</code> para crear el dispositivo de red&nbsp;virtual.</p>
<p>Llegado este momento, si <code>/sbin</code> no forma parte de la variable de entorno <code>PATH</code>, nuestro script&nbsp;fallará.</p>
<p>Invocar a <code>/etc/init.d/openvpn start | stop</code> para establecer y parar la conexión requiere utilizar los ficheros de configuración ubicados en <code>/etc/openvpn</code> y jugar con <code>/etc/default/openvpn</code> para que el script de inicialización haga lo que queremos. Así, una opción más fácil puede ser llamar a openvpn con un script similar a este, evitando parar accidentalmente sesiones de vpn no&nbsp;deseadas.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s1">&#39;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#39;</span>
/usr/sbin/openvpn --daemon --writepid /var/run/myvpn --cd /root/vpn --config /root/vpn/client.conf
/bin/sleep <span class="m">16</span>
... <span class="o">(</span>lo que sea que hagamos por la VPN... acceso seguro a svn por ejemplo<span class="o">)</span>...
/bin/kill <span class="k">$(</span>cat /var/run/myvpn<span class="k">)</span>  rm /var/run/mypid
</pre></div>


<ul>
<li>Con <code>PATH</code> aseguramos que OpenVPN, al correr como hijo del cron encuentra el comando <code>ifconfig</code>.</li>
<li>Con <code>--daemon</code>, OpenVPN corre como demonio. De lo contrario, el script nunca pasaria de esta&nbsp;lnea.</li>
<li>Con <code>--writepid /var/run/myvpn</code> escribimos el <span class="caps">PID</span> del proceso OpenVPN en el fichero <code>/var/run/myvpn</code>. Esto nos permite matar sólo esa sessión de vpn con <code>killall</code> más&nbsp;adelante.</li>
<li><code>sleep</code> es sálo para asegurar que el dispositovo <span class="caps">TAP</span> y las rutas existan antes de&nbsp;utilizarlas.</li>
</ul>
<p>Finalmente matamos sólo la conexión vpn establecida por este&nbsp;script.</p>
<p>Por otro lado, si además de los certificados y claves necesitamos de una autenticación mediante user y password, deberemos especificar el fichero que los contiene tras la opción <code>auth-user-pass /root/vpn/up</code>. Esta opción suele estar en en fichero <code>client.conf</code> y es la responsable de que se te pregunte que introduzcas un usuairo y password en aquellas conexines que asi lo requieren. De hecho, todas las opciones que hemos pasado a openvpn por linea de comandos mediante <code>--opcion</code>, pueden ir en dicho fichero de configuración si as lo&nbsp;deseamos.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>