<!DOCTYPE html>
<html lang="es">
<head>
          <title>frommelmak - lsof: Practical usage&nbsp;examples</title>
        <meta charset="utf-8" />




    <meta name="tags" content="lsof" />
    <meta name="tags" content="sysadmin" />
    <meta name="tags" content="tools" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://frommelmak.com/">frommelmak <strong>Yet another Melmacian interested in technology...</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Home</a></li>
            <li><a href="https://frommelmak.com/pages/about.html">About</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://frommelmak.com/lsof-practical-usage-examples.html" rel="bookmark"
         title="Permalink to lsof: Practical usageÂ examples">lsof: Practical usage&nbsp;examples</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2014-06-03T19:53:00+02:00">
      Tue 03 June 2014
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://frommelmak.com/author/frommelmak.html">frommelmak</a>
    </address>
    <div class="category">
        Category: <a href="https://frommelmak.com/category/english.html">English</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://frommelmak.com/tag/lsof.html">lsof</a>
            <a href="https://frommelmak.com/tag/sysadmin.html">sysadmin</a>
            <a href="https://frommelmak.com/tag/tools.html">tools</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>As you probably know, <code>lsof</code> stands for List of Open Files. Yes, it&#8217;s seems a simple description for a simple Unix command but, wait! Have you ever heard that everything in Unix is a file? Yes, right? So maybe this tool is more powerful than you&nbsp;think.</p>
<p>Let me show you how powerful it is with a bunch of practical examples (use&nbsp;root):</p>
<p>Lists all open files belonging to all active&nbsp;processes.</p>
<div class="highlight"><pre><span></span>lsof
</pre></div>


<p>Shows all files opened by the <code>www-data</code> user </p>
<div class="highlight"><pre><span></span>lsof -u www-data
</pre></div>


<p>Lists just all the PIDs of the processes opened by the <code>www-data</code> user</p>
<div class="highlight"><pre><span></span>lsof -t -u www-data
</pre></div>


<p>Kills all the activity for a particular&nbsp;user</p>
<div class="highlight"><pre><span></span>killall -9 <span class="sb">`</span>lsof -t -u username<span class="sb">`</span>
</pre></div>


<p>Lists all the files opened by the process with the <code>PID</code> 234</p>
<div class="highlight"><pre><span></span>lsof -p <span class="m">234</span>
</pre></div>


<p>Lists processes which are using a specific&nbsp;file.</p>
<div class="highlight"><pre><span></span>lsof -t /var/log/auth.log
</pre></div>


<p>Lists all the log files in&nbsp;use.</p>
<div class="highlight"><pre><span></span>lsof +D /var/log
</pre></div>


<p>Lists all the opened files in a <span class="caps">NFS</span>&nbsp;folder</p>
<div class="highlight"><pre><span></span>lsof +D -N /mnt/nfsstorage
</pre></div>


<p>Lists of the files opened by the processes whose command begins with the characters of&nbsp;&#8220;chrome&#8221;.</p>
<div class="highlight"><pre><span></span>lsof -c chrome
</pre></div>


<p>Until here we were focused on regular files. But, what if we start listing special files like network files&nbsp;?</p>
<p>Lists all network connections (Yes! Because everything in Unix is a&nbsp;file)</p>
<div class="highlight"><pre><span></span>lsof -i
</pre></div>


<p>Lists all network connections on port&nbsp;80</p>
<div class="highlight"><pre><span></span>lsof -i:80
</pre></div>


<p>Lists of all network connections on privileged&nbsp;ports,</p>
<div class="highlight"><pre><span></span>lsof -i:1-1024
</pre></div>


<p>Lists all IPv4 connections on the&nbsp;system</p>
<div class="highlight"><pre><span></span>lsof -i4
</pre></div>


<p>See localhost&nbsp;connections.</p>
<div class="highlight"><pre><span></span>lsof -i <span class="m">4</span>@127.0.0.1
</pre></div>


<p>Shows all listening <span class="caps">TCP</span>/<span class="caps">UDP</span>&nbsp;ports</p>
<div class="highlight"><pre><span></span>lsof -Pan -i tcp -i udp
</pre></div>


<p>Shows all connections on port 80 using a <span class="caps">TCP</span>&nbsp;socket.</p>
<div class="highlight"><pre><span></span>lsof -i TCP:80
</pre></div>


<p>Shows al <span class="caps">TCP</span> sockets listening on the&nbsp;system.</p>
<div class="highlight"><pre><span></span>lsof -i -sTCP:LISTEN
</pre></div>


<p>Shows all listening or established connection <span class="caps">TCP</span> ipv4&nbsp;sockets.</p>
<div class="highlight"><pre><span></span>lsof -s TCP:ESTABLISHED,LISTEN -i4TCP
</pre></div>


<p>Check what services are still using old removed libraries and need to be&nbsp;reloaded.</p>
<div class="highlight"><pre><span></span>lsof -n <span class="p">|</span> grep ssl <span class="p">|</span> grep DEL
</pre></div>


<p>Find processes that need to be restarted after updating&nbsp;binaries.</p>
<div class="highlight"><pre><span></span>sudo lsof -d txt <span class="p">|</span> grep <span class="s1">&#39;(deleted)&#39;</span>
</pre></div>


<p>And now let&#8217;s get stared with the device&nbsp;files.</p>
<p>Find out what processes are using your&nbsp;webcam.</p>
<div class="highlight"><pre><span></span>lsof /dev/video0
</pre></div>


<p>Find out what processes are using your sound&nbsp;card.</p>
<div class="highlight"><pre><span></span>sudo lsof +D /dev/snd
</pre></div>


<p>The next one is one of my favorites. Displays all deleted files that are still open, and thus still occupy disk space, but are not part of any directory.
For example if you delete a big log file while it still opened by another&nbsp;process.</p>
<div class="highlight"><pre><span></span>lsof +L1
</pre></div>


<p>Now the definitive one. See how <code>lsof</code> can help you to recover a deleted&nbsp;file!</p>
<p>Imagie you deleted the <code>syslog</code> file accidentaly. As we said before, you can see some metadata from the deleted file using <code>lsof</code>.
Using the process (<code>PID</code>), and the file descriptor (<code>FD</code>) identifiers you can recover the&nbsp;file:</p>
<div class="highlight"><pre><span></span>COMMAND    PID       USER   FD   TYPE DEVICE SIZE/OFF NLINK    NODE NAME
insync    <span class="m">2432</span> frommelmak   30u   REG    <span class="m">8</span>,1     <span class="m">9252</span>     <span class="m">0</span> <span class="m">4326104</span> /var/tmp/etilqs_KFgJC2dGc3A3p9r <span class="o">(</span>deleted<span class="o">)</span>
soffice.b <span class="m">3377</span> frommelmak   23u   REG    <span class="m">8</span>,1     <span class="m">4096</span>     <span class="m">0</span>  <span class="m">789414</span> /home/frommelmak/.execoooAMcD6a <span class="o">(</span>deleted<span class="o">)</span>
syslog-ng <span class="m">1046</span> root         10w   REG    <span class="m">8</span>,1     <span class="m">278428</span>   <span class="m">0</span>   <span class="m">20198</span> /var/log/syslog <span class="o">(</span>deleted<span class="o">)</span>
</pre></div>


<p>Now you can recover the file as&nbsp;follows:</p>
<div class="highlight"><pre><span></span>cat /proc/1046/fd/10 &gt; /var/log/syslog
</pre></div>


<p>If you really want to release the space used by the syslog file without restart the <code>syslog</code> process, you can do something like&nbsp;this:</p>
<div class="highlight"><pre><span></span>&gt; /var/log/syslog
</pre></div>


<p>Or&nbsp;just:</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt; /var/log/syslog
</pre></div>


<p>Finally you can put the <code>lsof</code> command in a repeat mode using <code>-|+r</code>. The prefix <code>-</code> puts the lsof in endless mode. You need to send a control signal to exit.
With the <code>+</code> prefix, <code>lsof</code> ends when there&#8217;s no output for the given&nbsp;parameters.</p>
<p>This article just cover the basics about <code>lsof</code>. For a complete list of features <span class="caps">RTFM</span>!</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>