<!DOCTYPE html>
<html lang="es">
<head>
          <title>frommelmak - Implementación de hilos de ejecución en <span class="caps">GNU</span>/Linux</title>
        <meta charset="utf-8" />




    <meta name="tags" content="threads" />
    <meta name="tags" content="hilos" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://frommelmak.com/">frommelmak <strong>Yet another Melmacian interested in technology...</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Home</a></li>
            <li><a href="https://frommelmak.com/pages/about.html">About</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://frommelmak.com/implementacion-de-hilos-de-ejecucion-en-gnulinux.html" rel="bookmark"
         title="Permalink to Implementación de hilos de ejecución en GNU/Linux">Implementación de hilos de ejecución en <span class="caps">GNU</span>/Linux</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2007-01-25T19:01:52+01:00">
      Thu 25 January 2007
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://frommelmak.com/author/frommelmak.html">frommelmak</a>
    </address>
    <div class="category">
        Category: <a href="https://frommelmak.com/category/spanish.html">Spanish</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://frommelmak.com/tag/threads.html">threads</a>
            <a href="https://frommelmak.com/tag/hilos.html">hilos</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Llevo muchísimo tiempo lidiando con el sistema de paquetes <span class="caps">RPM</span> de Red Hat y la verdad es que nunca antes me haba encontrado con nada parecido al problema con el que me encontré a principios de&nbsp;semana.</p>
<p>El problema se resume así: Trabajando en un sistema vía <span class="caps">SSH</span> (Putty), me di cuenta que al hacer <code>RPM -q &lt;paquete&gt;</code> me retornaba una versión de paquete distinta que si en ese mismo sistema lanzaba un <code>ssh rpm -q &lt;paquete&gt;</code> desde otra máquina. Dado que lo único que podía cambiar de uno a otro escenario eran las variables de entorno bajo las cuales se ejecutaba la orden, me puse a ver cual era la que originaba el problema. Tras unas cuantas pruebas vi que la culpable era una variable llamada <code>LD_ASSUME_KERNEL</code>.</p>
<p>Como no tenia ni idea de en que manera podía esto afectar al resultado de una <em>query</em> tan simple a la base de datos <span class="caps">RPM</span>, empecé a documentarme sobre qué demonios hacía esta variable. Tras un buen rato tirando del <strong><span class="caps">HILO</span></strong> di con la&nbsp;respuesta. </p>
<p>El documento que viene a continuación intenta resumir todo lo que he aprendido a raíz de la dichosa&nbsp;variable.</p>
<p>Si lo preferís, podéis descargarlo en <span class="caps">PDF</span> desde <a href="http://nomeriasdeti.no-ip.com/files/docs/IHEGL.pdf">aquí</a>.</p>
<h1>Implementación de hilos de ejecución en sistemas <span class="caps">GNU</span>/Linux</h1>
<h2>LinuxThreads vs Native <span class="caps">POSIX</span> Threads (<span class="caps">NPTL</span>)</h2>
<p>23-Jan-2007
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#102;&#114;&#111;&#109;&#109;&#101;&#108;&#109;&#97;&#107;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#102;&#114;&#111;&#109;&#109;&#101;&#108;&#109;&#97;&#107;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></p>
<h3>Diferencias entre hilos de ejecución (threads) y&nbsp;procesos</h3>
<p>A grandes rasgos, la principal diferencia entre un proceso y un <em>thread</em> es que en la mayoría de los sistemas operativos, un proceso es una entidad relativamente independiente que dispone de su propio espacio de direcciones, su propia información de estado y que utiliza los mecanismos de comunicación entre procesos que le proporciona el sistema operativo para comunicarse con otros&nbsp;procesos.</p>
<p>Por otro lado, un <em>thread</em> seria una entidad más reducida capaz de convivir junto a otros <em>threads</em> bajo el contexto de un único proceso, permitiendo compartir la información de estado, el área de memoria y/o los recursos asociados a ese&nbsp;proceso.</p>
<p>Así, un <em>thread</em> no sería más que la habilidad de un proceso o programa para dividirse en varios hilos de ejecución simultáneos o aparentemente&nbsp;simultáneos.</p>
<p>Desde el punto de vista del algoritmo de scheduling del kernel -que decide que proceso ha de pasar a la <span class="caps">CPU</span> en cada momento- el proceso seria la unidad más grande capaz de ser manejada por el scheduler, mientras que el hilo seria la unidad más pequea capaz de ser llevada a la <span class="caps">CPU</span> por el scheduler del&nbsp;kernel.</p>
<h3>Hilos de ejecución en <span class="caps">GNU</span>/Linux</h3>
<p>Antes de la versión 2.6 del kernel Linux, no haba soporte real para manejar hilos a nivel de kernel. Las primeras versiones para el manejo de hilos en Linux (LinuxThreads) se implementaron en el área de usuario mediante llamadas a una función de sistema <code>clone()</code>, capaz de crear una copia de un proceso. Esta primera implementación además estaba muy lejos de ser compatible con los estándares <span class="caps">POSIX</span> de hilos de ejecución (<span class="caps">POSIX</span> threading&nbsp;standards).</p>
<p>Para mejorar el soporte de hilos en Linux, fueron necesarios retoques tanto a nivel de kernel (y su <span class="caps">ABI</span>) como a nivel de las libreras <span class="caps">GNU</span> C Library (Glibc) que implementaban el concepto de&nbsp;hilo.</p>
<p>Esto dio lugar a varios modelos/proyectos para la gestin de hilos, dependiendo de lo nuevo que fuera el&nbsp;sistema:</p>
<ul>
<li>LinuxThreads (with fixed stack&nbsp;size) </li>
<li>LinuxThreads (with floating&nbsp;stacks) </li>
<li><span class="caps">NGPT</span> (Next Generation <span class="caps">POSIX</span> Threads) liderado por <span class="caps">IBM</span> y abandonado  por <span class="caps">NPTL</span>.</li>
<li><span class="caps">NPTL</span> (Native <span class="caps">POSIX</span> Thread) Proyecto liderado por Red Hat y liberado en&nbsp;2003.</li>
</ul>
<p>Al añadir nuevas posibilidades al trabajo con hilos en el kernel de linux, se inició una etapa de transición en la que algunas aplicaciones requerían un esquema de hilos moderno (<span class="caps">NPTL</span>), mientras que otras utilizaban otro más tradicional como LinuxThreads. Todo ello, teniendo el sistema que poder correr aplicaciones basadas en un modelo de hilos más o menos&nbsp;avanzado.</p>
<p>Como se ha comentado al inicio, los nuevos modelos de soporte de hilos requerían cambios también a nivel de kernel. As, las diferentes libreras dinámicas (<span class="caps">DSO</span> Dinamic Shared Objects/Shared Libraries), además de una librera de hilos concreta, requerirán de una versión del kernel con una interfaz capaz de trabajar con dicha librera. A esta interfaz se la conoce con el nombre de Application Binary Interface (<span class="caps">ABI</span>).</p>
<p>Una <span class="caps">ABI</span> define la interfaz de bajo nivel entre la Aplicación y el sistema operativo o kernel , mientras que una <span class="caps">API</span> define el interfaz entre el código fuente y las&nbsp;libreras. </p>
<p>De la misma forma que una <span class="caps">API</span> permite que un código fuente sea compilado en cualquier sistema que soporte para dicha <span class="caps">API</span>, la <span class="caps">ABI</span> permite que un objeto binario pueda funcionar en un sistema con una <span class="caps">ABI</span>&nbsp;compatible.</p>
<p>Los <span class="caps">DSO</span> incluyen información relativa a la versión de <span class="caps">ABI</span> requerida, de manera que el enlazador o cargador dinámico (<span class="caps">LD</span>) de las Glibc (<code>ld.so/ld-linux.so</code>) sabe la versión <span class="caps">ABI</span> requerida por el <span class="caps">DSO</span>.</p>
<p>Las ABIs disponibles dependen de la versión del kernel que utilice el sistema, mientras que el modelo de hilos utilizado depende de las libreras de hilos (<code>libpthread.so</code>) disponibles. La decisión de qué libreras utilizar la toma el enlazador&nbsp;dinámico.</p>
<p>Así, la incursión de un nuevo modelo de hilos requería también de retoques en el enlazador dinámico de libreras, a fin de asegurar la compatibilidad total con las aplicaciones ya existentes, además de los ya mencionados cambios en el sistema (kernel y librera de implementación de&nbsp;hilos).</p>
<p>El enlazador dinámico (<code>ld-linux.so</code>) de DSOs (Dynamic Share Object .so) forma parte de las Glibc, y es capaz de ver los requerimientos en cuanto a kernel/<span class="caps">ABI</span> de un <span class="caps">DSO</span> y llamar a las librerías necesarias/compatibles en cada caso. En Red Hat 9, Fedora Core 1 y 2, estas libreras están en <code>/lib</code>, <code>/lib/i686</code> y <code>/lib/tls</code> en función de si implementan un sistema de hilos LinuxTread (fixed stacks), LinuxTread (floating stacks) o <span class="caps">NPTL</span>&nbsp;respectivamente.</p>
<h3>La variable <code>LD_ASSUME_KERNEL</code></h3>
<p>En los sistemas Red Hat Linux en los que conviven los diferentes acercamientos al modelo de hilos (LinuxThread y <span class="caps">NPTL</span>), existe una variable de entorno llamada <code>LD_ASSUME_KERNEL</code>  capaz de modificar el comportamiento normal del enlazador dinámico de las Glibc para utilizar los <span class="caps">DSO</span>/<span class="caps">ABI</span> de uno u otro modelo de&nbsp;hilos.</p>
<p>En sistemas relativamente modernos, las libreras Glibc incluyen diferentes versiones de libreras capaces de implementar uno u otro modelo de&nbsp;hilos: </p>
<ul>
<li><code>/lib/libpthread.so.0</code>      (LinuxThreads fixed stack&nbsp;size)</li>
<li><code>/lib/i686/libpthread-0.10.so</code> (LinuxThreads floating&nbsp;stacks)</li>
<li><code>/lib/tls/libpthread-0.34.so</code>   (<span class="caps">NPTL</span> disponible por primera vez en Red Hat&nbsp;9)</li>
</ul>
<p>Para saber el modelo de hilos utilizado podemos utilizar el comando&nbsp;getconf.</p>
<div class="highlight"><pre><span></span><span class="go">getconf GNU_LIBPTHREAD_VERSION</span>
<span class="go">NPTL 0.34</span>
</pre></div>


<p>Como hemos dicho, si bien en Red Hat 9 <span class="caps">NPTL</span> es el modelo de hilos utilizado por defecto, utilizando la variable <code>LD_ASSUME_KERNEL</code>, es posible forzar al enlazador dinámico (Dynamic Linker <span class="caps">LD</span>) a la hora de cargar los DSOs requeridos por un programa, de manera que cargue los correspondientes a un modelo de threads u otro al <span class="caps">ASUMIR</span> que la <span class="caps">ABI</span> que le ofrecer el kernel es de una versión anterior a la del kernel actualmente en&nbsp;ejecución.</p>
<div class="highlight"><pre><span></span><span class="err">LD_ASSUME_KERNEL=2.2.5</span>
<span class="err">getconf GNU_LIBPTHREAD_VERSION</span>
<span class="err">linuxthreads-0.10</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">LD_ASSUME_KERNEL=2.4.1</span>
<span class="err">getconf GNU_LIBPTHREAD_VERSION</span>
<span class="err">linuxthreads-0.10</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">LD_ASSUME_KERNEL=2.4.20</span>
<span class="err">getconf GNU_LIBPTHREAD_VERSION</span>
<span class="err">NPTL 0.34 </span>
</pre></div>


<p>Mediante el comando <code>eu-readelf</code> presente en el paquete <code>elfutil</code>s, es posible saber el modelo de <span class="caps">ABI</span> requerido por un <span class="caps">DSO</span>.</p>
<div class="highlight"><pre><span></span><span class="go">eu-readelf -n /lib/libnss_nis.so.1</span>

<span class="go">Note segment of 32 bytes at offset 0x000000f4:</span>
<span class="go">Owner          Data size  Type</span>
<span class="go">GNU                   16  VERSION</span>
<span class="go">OS: Linux, ABI: 2.2.5</span>
</pre></div>


<p>En el ejemplo anterior, la librera <code>libnss_nis.so.1</code> requiere de una <span class="caps">ABI</span>/Kernel superior o igual a la que ofrecía un kernel de la versión&nbsp;2.2.5.</p>
<p>Otros&nbsp;ejemplos:</p>
<div class="highlight"><pre><span></span><span class="n">eu</span><span class="o">-</span><span class="n">readelf</span> <span class="o">-</span><span class="n">n</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="n">so</span>

<span class="n">Note</span> <span class="n">segment</span> <span class="k">of</span> <span class="mi">32</span> <span class="n">bytes</span> <span class="k">at</span> <span class="k">offset</span> <span class="mi">0</span><span class="n">x00000114</span><span class="p">:</span>
<span class="k">Owner</span>          <span class="k">Data</span> <span class="k">size</span>  <span class="k">Type</span>
<span class="n">GNU</span>                   <span class="mi">16</span>  <span class="n">VERSIONOS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">,</span> <span class="n">ABI</span><span class="p">:</span> <span class="mi">2</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">1</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">eu-readelf -n /lib/tls/libc-2.3.2.so</span>
<span class="err">Note segment of 32 bytes at offset 0x00000134:</span>
<span class="err">Owner          Data size  Type</span>
<span class="err">GNU                   16  VERSIONOS: Linux, ABI: 2.4.20</span>
</pre></div>


<h3>Errores derivados de un mal uso de <code>LD_ASSUME_KERNEL</code></h3>
<p>Las utilidades del sistema de paquetes <span class="caps">RPM</span> dependen de libreras que requieren una <span class="caps">ABI</span> y libreras con capacidades <span class="caps">NPTL</span>. Si utilizamos la variable <code>LD_ASSUME_KERNEL</code> para forzar al enlazador dinámico a utilizar las libreras de la implementación de hilos LinuxThreads, corremos el riesgo de obtener resultados inesperados o incluso de corromper la base de datos Berkley <span class="caps">DB</span> del sistema <span class="caps">RPM</span>, ya que esta base de datos está pensada y optimizada para su ejecución en un entorno de hilos <span class="caps">NPTL</span>.</p>
<p>Es por este motivo que es recomendable estar seguros de que <span class="caps">NO</span> hemos modificado el valor de dicha variable de entorno antes de proceder a construir, o instalar un paquete mediante las herramientas del sistema de paquetes <span class="caps">RPM</span>.</p>
<p>Las capturas siguientes muestran la estrecha relación que existe entre las herramientas <span class="caps">RPM</span> y el modelo de hilos <span class="caps">NPTL</span>.</p>
<div class="highlight"><pre><span></span><span class="err">ldd /bin/rpm</span>
<span class="err">librpm-4.2.so = /usr/lib/librpm-4.2.so (0x4002a000)</span>
<span class="err">librpmdb-4.2.so = /usr/lib/librpmdb-4.2.so (0x4007e000)</span>
<span class="err">librpmio-4.2.so = /usr/lib/librpmio-4.2.so (0x4015d000)</span>
<span class="err">libpopt.so.0 = /usr/lib/libpopt.so.0 (0x401bb000)</span>
<span class="err">libelf.so.1 = /usr/lib/libelf.so.1 (0x401c3000)</span>
<span class="err">libpthread.so.0 = tls/libpthread.so.0 (0x401d3000)</span>
<span class="err">librt.so.1 = tls/librt.so.1 (0x401e2000)</span>
<span class="err">libbz2.so.1 = /usr/lib/libbz2.so.1 (0x401f4000)</span>
<span class="err">libc.so.6 = tls/libc.so.6 (0x42000000)</span>
<span class="err">/lib/ld-linux.so.2 = /lib/ld-linux.so.2 (0x40000000)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">ldd /usr/bin/rpmbuild</span>
<span class="err">librpmbuild-4.2.so = /usr/lib/librpmbuild-4.2.so (0x00bba000)</span>
<span class="err">librpm-4.2.so = /usr/lib/librpm-4.2.so (0x008a3000)</span>
<span class="err">librpmdb-4.2.so = /usr/lib/librpmdb-4.2.so (0x00252000)</span>
<span class="err">librpmio-4.2.so = /usr/lib/librpmio-4.2.so (0x00380000)</span>
<span class="err">libpopt.so.0 = /usr/lib/libpopt.so.0 (0x00d26000)</span>
<span class="err">libelf.so.1 = /usr/lib/libelf.so.1 (0x00aef000)</span>
<span class="err">libbeecrypt.so.6 = /usr/lib/libbeecrypt.so.6 (0x0061a000)</span>
<span class="err">librt.so.1 = /lib/tls/librt.so.1 (0x00d56000)</span>
<span class="err">libpthread.so.0 = /lib/tls/libpthread.so.0 (0x005ac000)</span>
<span class="err">libz.so.1 = /usr/lib/libz.so.1 (0x00c0e000)</span>
<span class="err">libbz2.so.1 = /usr/lib/libbz2.so.1 (0x00e55000)</span>
<span class="err">libc.so.6 = /lib/tls/libc.so.6 (0x00111000)</span>
<span class="err">/lib/ld-linux.so.2 = /lib/ld-linux.so.2 (0x00364000)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">eu-readelf -n /lib/tls/librt.so.1</span>
<span class="err">Note segment of 32 bytes at offset 0x00000134:</span>
<span class="err">Owner          Data size  Type</span>
<span class="err">GNU                   16  VERSION</span>
<span class="c">OS: Linux, ABI: 2.4.20</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">eu-readelf -n /lib/tls/libpthread.so.0</span>
<span class="err">Note segment of 32 bytes at offset 0x00000114:</span>
<span class="err">Owner          Data size  Type</span>
<span class="err">GNU                   16  VERSION</span>
<span class="c">OS: Linux, ABI: 2.4.20</span>
</pre></div>


<p>La conclusión que cabe sacar de todo esto es que un abuso de la variable <code>LD_ASSUME_KERNEL</code> puede tener consecuencias inesperadas y hacernos perder mucho tiempo tratando de averiguar qué es lo que esta provocando el&nbsp;problema.</p>
<p>La regla sera dejar que sea el sistema el encargado de establecer el modelo de hilos bajo en que se ha de ejecutar cada aplicación y solo forzar un modelo distinto cuando estemos seguros que es eso lo que requiere nuestra&nbsp;aplicación.</p>
<h3>Bibliografa:</h3>
<p><em>Wikipedia</em></p>
<ul>
<li><a href="">http://en.wikipedia.org/wiki/Thread_%28computer_science%29</a></li>
</ul>
<p><em>Red&nbsp;Hat</em></p>
<ul>
<li><a href="">http://people.redhat.com/drepper/assumekernel.html</a></li>
</ul>
<p><em><span class="caps">IBM</span></em></p>
<ul>
<li><a href="">http://publib.boulder.ibm.com/infocenter/wasinfo/v5r1//index.jsp?topic=/com.ibm.websphere.base.doc/info/aes/ae/cins_nptl.html</a></li>
<li><a href="">http://www-128.ibm.com/developerworks/linux/library/l-threading.html?ca=dgr-lnxw07LinuxThreadsAndNPTL</a></li>
</ul>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>