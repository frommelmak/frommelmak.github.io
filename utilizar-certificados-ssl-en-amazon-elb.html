<!DOCTYPE html>
<html lang="es">
<head>
          <title>frommelmak - Utilizar certificados <span class="caps">SSL</span> en Amazon <span class="caps">ELB</span></title>
        <meta charset="utf-8" />




    <meta name="tags" content="amazon" />
    <meta name="tags" content="aws" />
    <meta name="tags" content="elb" />
    <meta name="tags" content="ssl" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://frommelmak.com/">frommelmak <strong>Yet another Melmacian interested in technology...</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Home</a></li>
            <li><a href="https://frommelmak.com/pages/about.html">About</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://frommelmak.com/utilizar-certificados-ssl-en-amazon-elb.html" rel="bookmark"
         title="Permalink to Utilizar certificados SSL en Amazon ELB">Utilizar certificados <span class="caps">SSL</span> en Amazon <span class="caps">ELB</span></a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2015-02-26T19:03:23+01:00">
      Thu 26 February 2015
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://frommelmak.com/author/frommelmak.html">frommelmak</a>
    </address>
    <div class="category">
        Category: <a href="https://frommelmak.com/category/english.html">English</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://frommelmak.com/tag/amazon.html">amazon</a>
            <a href="https://frommelmak.com/tag/aws.html">aws</a>
            <a href="https://frommelmak.com/tag/elb.html">elb</a>
            <a href="https://frommelmak.com/tag/ssl.html">ssl</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>En esta entrada voy a tratar de explicar cómo utilizar el servicio de balanceo de carga de Amazon (<span class="caps">ELB</span>) como terminador de conexiones <span class="caps">SSL</span>.</p>
<p>El escenario de partida sería&nbsp;este:</p>
<p><img alt="ELB HTTP" src="/images/ELB_HTTP_server.png"></p>
<p>Como se observa en este diagrama, todo el tráfico va en plano. Desde el cliente <span class="caps">HTTP</span> del usuario/aplicación hasta las instancias que ofrecen el servicio <span class="caps">HTTP</span>.</p>
<p>El objetivo es cifrar todo el tráfico entre la aplicación y nuestros servidores. Para ello, lo más sencillo es configurar nuestro balanceador de carga como terminador de las conexiones <span class="caps">SSL</span>. Así, conseguimos de forma transparente el acceso cifrado a los servicios <span class="caps">HTTP</span>, ya que evitamos tener que añadir el certificado a cada uno de los servicios a&nbsp;securizar.</p>
<p>Otra ventaja es que el tráfico seguirá llegando en plano a las instancias, facilitando así el debug de posibles problemas que requieran analizar el&nbsp;tráfico. </p>
<p><img alt="ELB" src="/images/ELB_SSL_HTTPS_server.png"></p>
<p>El cifrado <span class="caps">SSL</span>/<span class="caps">TLS</span> utilizado por el protocolo <span class="caps">HTTPS</span>, utiliza criptografía de clave pública (o asimétrica) para autenticar la identidad del servidor con el que estamos comunicando. Esta, también se utiliza para intercambiar la clave simétrica que se utilizará para cifrar el&nbsp;tráfico.</p>
<p>A grandes rasgos los pasos a seguir para añadir un certificado al balaceador de carga son&nbsp;estos:</p>
<ol>
<li>Obtener el certificado <span class="caps">SSL</span><ul>
<li>Generar una clave&nbsp;privada.</li>
<li>Generar la solicitud del certificado (<a href="http://en.wikipedia.org/wiki/Certificate_signing_request"><span class="caps">CSR</span></a>) a partir de la clave&nbsp;privada.</li>
<li>Solicitar un certificado <span class="caps">SSL</span> a nuestra autoridad certificadora (<a href="http://en.wikipedia.org/wiki/Certificate_authority"><span class="caps">CA</span></a>): <a href="https://www.godaddy.com">Goodady</a> en este&nbsp;ejemplo.</li>
</ul>
</li>
<li>Convertir el certificado al formato soportado por&nbsp;Amazon.</li>
<li>Subir el certificado a&nbsp;Amazon. </li>
<li>Añadir listener <span class="caps">HTTPS</span> al balanceador y configurarlo con el nuevo&nbsp;certificado.</li>
</ol>
<h2>1 Obtener el certificado <span class="caps">SSL</span></h2>
<p>Creamos una clave privada que utilizaremos para crear la solicitud de&nbsp;certificado. </p>
<div class="highlight"><pre><span></span>openssl genrsa -out my-private-key-file.pem <span class="m">2048</span>
</pre></div>


<p>Creamos la solicitud de firma del certificado: Certificate Signing Request (<span class="caps">CSR</span>). La solicitud no es más que un fichero creado a partir de la clave privada que utilizaremos para solicitar un certificado <a href="http://en.wikipedia.org/wiki/X.509">X.509</a> a la autoridad&nbsp;certificadora.</p>
<div class="highlight"><pre><span></span>openssl req -sha256 -new -key my-private-key-file.pem -out csr.pem
</pre></div>


<p>Este proceso nos realizará un una serie de preguntas. Hemos de prestar especial atención al valor que introducimos&nbsp;para:</p>
<ul>
<li>Common&nbsp;Name</li>
</ul>
<p>Nos aseguraremos de que corresponda con el <a href="http://en.wikipedia.org/wiki/Fully_qualified_domain_name"><span class="caps">FQDN</span></a> que vamos a utilizar para nuestro&nbsp;dominio.</p>
<p>Verificamos que la información que hemos introducido es&nbsp;correcta:</p>
<div class="highlight"><pre><span></span>openssl req -in csr.pem -noout -text
</pre></div>


<p>Con el fichero <code>csr.pem</code>  generado, solicitamos el certificado a nuestra <span class="caps">CA</span>. GoDaddy en este&nbsp;caso.</p>
<h2>2 Convertir el certificado al formato soportado por&nbsp;Amazon</h2>
<p>La <span class="caps">CA</span> nos retorna el certificado en dos ficheros con nombres similares a&nbsp;estos:</p>
<p>Goodady files: <code>a0cde33bcde324cd.crt</code> + <code>gd_bundle-g2-g1.crt</code></p>
<p>El primer fichero es nuestro certificado. El segundo la certificate chain: una lista de certificados y el certificado raiz de&nbsp;Godaddy.</p>
<p>Amazon requiere que estos fichero estén en un formato soportado por el servicio <span class="caps">AWS</span> <span class="caps">IAM</span>. Así que deberemos convertir el certificado al formato soportado: <span class="caps">PEM</span> X.509 en este&nbsp;caso.</p>
<div class="highlight"><pre><span></span>openssl x509 -inform PEM -in a0cde33bcde324cd.crt &gt; my-public-key-file.pem
openssl x509 -inform PEM -in gd_bundle-g2-g1.crt &gt; my-certificate-chain-file.pem
</pre></div>


<h2>3 Subir el certificado a&nbsp;Amazon</h2>
<p>Ahora, con estos tres ficheros: La clave privada, nuestro certificado y los certificados de Goodady, podemos dar de alta el certificado en&nbsp;Amazon.</p>
<div class="highlight"><pre><span></span>iMac: frommelmak$ aws iam upload-server-certificate --server-certificate-name my-server-certificate --certificate-body file://my-public-key-file.pem --private-key file://my-private-key-file.pem --certificate-chain file://my-certificate-chain-file.pem
<span class="o">{</span>
    <span class="s2">&quot;ServerCertificateMetadata&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;ServerCertificateId&quot;</span>: <span class="s2">&quot;ASC...............JJJ&quot;</span>,
        <span class="s2">&quot;ServerCertificateName&quot;</span>: <span class="s2">&quot;my-server-certificate&quot;</span>,
        <span class="s2">&quot;Expiration&quot;</span>: <span class="s2">&quot;2016-02-25T15:27:49Z&quot;</span>,
        <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
        <span class="s2">&quot;Arn&quot;</span>: <span class="s2">&quot;arn:aws:iam::765165175371:server-certificate/my-server-certificate&quot;</span>,
        <span class="s2">&quot;UploadDate&quot;</span>: <span class="s2">&quot;2015-02-26T12:27:59.876Z&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Mediante el siguiente comando, verificamos que se ha subido&nbsp;correctamente:</p>
<div class="highlight"><pre><span></span>iMac: frommelmak$ aws iam get-server-certificate --server-certificate-name my-server-certificate
<span class="o">{</span>
        <span class="s2">&quot;ServerCertificate&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;CertificateChain&quot;</span>: <span class="s2">&quot;-----BEGIN CERTIFICATE-----\nMI ... JCa\n-----END CERTIFICATE-----&quot;</span>,
        <span class="s2">&quot;CertificateBody&quot;</span>: <span class="s2">&quot;-----BEGIN CERTIFICATE-----\nMI ... kkd\n-----END CERTIFICATE-----&quot;</span>,
        <span class="s2">&quot;ServerCertificateMetadata&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;ServerCertificateId&quot;</span>: <span class="s2">&quot;ASC...............JJJ&quot;</span>,
            <span class="s2">&quot;ServerCertificateName&quot;</span>: <span class="s2">&quot;my-server-certificate&quot;</span>,
            <span class="s2">&quot;Expiration&quot;</span>: <span class="s2">&quot;2016-02-25T15:27:49Z&quot;</span>,
            <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
            <span class="s2">&quot;Arn&quot;</span>: <span class="s2">&quot;arn:aws:iam::76........71:server-certificate/my-server-certificate&quot;</span>,
            <span class="s2">&quot;UploadDate&quot;</span>: <span class="s2">&quot;2015-02-26T12:27:59Z&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>4 Añadir listener <span class="caps">HTTPS</span> al balanceador y configurarlo con el nuevo&nbsp;certificado.</h2>
<p>Ahora ya sólo tenemos que añadir un nuevo Listener mediante la consola de&nbsp;Amazon.</p>
<p>En &#8220;Listener Configuration&#8221; del load balancer&nbsp;seleccionamos:</p>
<ul>
<li>Load Balancer Protocol: <span class="caps">HTTPS</span>(Secure <span class="caps">HTTP</span>)</li>
<li>Load Balancer Port:&nbsp;443</li>
<li>Instance Protocol:&nbsp;80</li>
<li>Instance Port:&nbsp;80</li>
</ul>
<p>En el momento de seleccionar el certificado utilizaremos la opción: &#8220;Choose an existing <span class="caps">SSL</span> Certificate&#8221;. Veremos que ya aparece el que acabamos de&nbsp;publicar.</p>
<ul>
<li>info: <a href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/ssl-server-cert.html">Elastic Load Balancing: <span class="caps">SSL</span> Server&nbsp;Cert</a></li>
</ul>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>